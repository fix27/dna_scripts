<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genome Annotation Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        .container {
            max-width: 1400px;
        }
        .upload-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #dee2e6;
        }
        .feature-table {
            width: 100%;
            margin-bottom: 1.5rem;
        }
        .feature-table th {
            background-color: #f1f1f1;
            position: sticky;
            top: 0;
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        .jbrowse-container {
            width: 100%;
            height: 600px; /* Fixed height for JBrowse container */
            border: 1px solid #dee2e6;
            margin-top: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .tool-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: #e7f5ff;
            border-radius: 0.5rem;
            border: 1px solid #c5d9e8;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .exon-item {
            background: #f8f9fa;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
        }
        .validation-valid {
            color: #28a745;
            font-weight: bold;
        }
        .validation-invalid {
            color: #dc3545;
            font-weight: bold;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4 text-center">Genome Annotation Tool</h1>
        
        <div class="upload-section">
            <h2 class="h4 mb-3">Upload Files</h2>
            <form id="uploadForm" method="POST" enctype="multipart/form-data" class="row g-3">
                <div class="col-md-6">
                    <label for="gff_file" class="form-label">GFF3 File</label>
                    <input type="file" class="form-control" id="gff_file" name="gff_file" accept=".gff,.gff3" required>
                    <div class="form-text">Upload your annotation file in GFF3 format</div>
                </div>
                <div class="col-md-6">
                    <label for="fasta_file" class="form-label">FASTA File</label>
                    <input type="file" class="form-control" id="fasta_file" name="fasta_file" accept=".fasta,.fa,.fna" required>
                    <div class="form-text">Upload your genomic sequence file</div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Upload and Parse</button>
                </div>
            </form>
        </div>
        
        <div id="mainContent" class="d-none">
            <!-- NEW LAYOUT FOR SEQUENCE INFO & GENOME BROWSER -->
            <!-- Sequence Information section - takes full width, appears first -->
            <div class="row mb-4">
                <div class="col-12"> <!-- Takes full width on all screen sizes -->
                    <h2 class="h4">Sequence Information</h2>
                    <div class="card">
                        <div class="card-body">
                            <p class="mb-1"><strong>ID:</strong> <span id="sequenceId" class="font-monospace"></span></p>
                            <p class="mb-0"><strong>Length:</strong> <span id="sequenceLength" class="font-monospace"></span> bp</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Genome Browser section - takes full width, appears below Sequence Info -->
            <div class="row mb-4">
                <div class="col-12"> <!-- Takes full width on all screen sizes -->
                    <h2 class="h4">Genome Browser</h2>
                    <div class="jbrowse-container">
                        <iframe id="jbrowseIframe" width="100%" height="100%" frameborder="0" style="border: 1px solid #ddd; background: #f8f9fa;" src="">
                        </iframe>
                    </div>
                </div>
            </div>
            <!-- END NEW LAYOUT -->
            
            <div class="tool-section">
                <h3 class="h5 mb-3">Tools</h3>
                <div class="row g-3">
                    <div class="col-md-4">
                        <button id="flipButton" class="btn btn-outline-primary w-100">Flip Sequence (Reverse Complement)</button>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="number" class="form-control" id="originPosition" min="1" step="1" placeholder="Position">
                            <button id="setOriginButton" class="btn btn-outline-primary">Set Origin</button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <select id="featureOrigin" class="form-select">
                                <option value="">Select Feature...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-12">
                        <button id="exportButton" class="btn btn-primary">Export GFF3 + FASTA</button>
                    </div>
                </div>
            </div>
            
            <h2 class="h4 mb-3">Features</h2>
            <div class="table-responsive">
                <table class="feature-table table table-striped table-hover table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Type</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Strand</th>
                            <th>Gene</th>
                            <th>Product</th>
                            <th>Notes</th>
                            <th>Codon Start</th>
                            <th>Exons</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="featureTableBody">
                        <!-- Features will be added here dynamically -->
                    </tbody>
                </table>
            </div>
            <button id="addFeatureButton" class="btn btn-success">Add New Feature</button>
        </div>
    </div>

    <!-- Edit Feature Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Feature</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editFeatureForm">
                        <input type="hidden" id="editFeatureIndex">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="editType" class="form-label">Type</label>
                                <select id="editType" class="form-select" required>
                                    <option value="gene">gene</option>
                                    <option value="CDS">CDS</option>
                                    <option value="tRNA">tRNA</option>
                                    <option value="rRNA">rRNA</option>
                                    <option value="mRNA">mRNA</option>
                                    <option value="misc_feature">misc_feature</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="editStart" class="form-label">Start</label>
                                <input type="number" class="form-control" id="editStart" min="1" required>
                            </div>
                            <div class="col-md-4">
                                <label for="editEnd" class="form-label">End</label>
                                <input type="number" class="form-control" id="editEnd" min="1" required>
                            </div>
                            <div class="col-md-4">
                                <label for="editStrand" class="form-label">Strand</label>
                                <select id="editStrand" class="form-select" required>
                                    <option value="1">+</option>
                                    <option value="-1">-</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="editGene" class="form-label">Gene</label>
                                <input type="text" class="form-control" id="editGene">
                            </div>
                            <div class="col-md-4">
                                <label for="editProduct" class="form-label">Product</label>
                                <input type="text" class="form-control" id="editProduct">
                            </div>
                            <div class="col-md-8">
                                <label for="editNote" class="form-label">Note</label>
                                <input type="text" class="form-control" id="editNote">
                            </div>
                            <div class="col-md-4">
                                <label for="editCodonStart" class="form-label">Codon Start</label>
                                <select id="editCodonStart" class="form-select">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="cdsValidationSection" class="row g-3 mb-3 d-none">
                            <div class="col-md-8">
                                <label for="editCodonTable" class="form-label">Codon Table (for CDS validation)</label>
                                <select id="editCodonTable" class="form-select">
                                    <!-- Codon tables will be loaded here -->
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="button" id="validateCdsButton" class="btn btn-outline-primary w-100">Validate CDS</button>
                            </div>
                            <div class="col-12">
                                <div id="validationResult" class="alert"></div>
                            </div>
                        </div>
                        
                        <h5 class="mt-4 mb-3">Exons</h5>
                        <div id="exonListContainer">
                            <ul id="exonList" class="list-unstyled">
                                <!-- Exons will be added here -->
                            </ul>
                        </div>
                        <button type="button" id="addExonButton" class="btn btn-outline-secondary btn-sm">Add Exon</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="editFeatureForm" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Processing...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const dom = {
            uploadForm: document.getElementById('uploadForm'),
            mainContent: document.getElementById('mainContent'),
            sequenceId: document.getElementById('sequenceId'),
            sequenceLength: document.getElementById('sequenceLength'),
            featureTableBody: document.getElementById('featureTableBody'),
            jbrowseIframe: document.getElementById('jbrowseIframe'),
            flipButton: document.getElementById('flipButton'),
            originPosition: document.getElementById('originPosition'),
            featureOrigin: document.getElementById('featureOrigin'),
            setOriginButton: document.getElementById('setOriginButton'),
            exportButton: document.getElementById('exportButton'),
            addFeatureButton: document.getElementById('addFeatureButton'),
            editModal: new bootstrap.Modal('#editModal'),
            editFeatureForm: document.getElementById('editFeatureForm'),
            editFeatureIndex: document.getElementById('editFeatureIndex'),
            editType: document.getElementById('editType'),
            editStart: document.getElementById('editStart'),
            editEnd: document.getElementById('editEnd'),
            editStrand: document.getElementById('editStrand'),
            editGene: document.getElementById('editGene'),
            editProduct: document.getElementById('editProduct'),
            editNote: document.getElementById('editNote'),
            editCodonStart: document.getElementById('editCodonStart'),
            editCodonTable: document.getElementById('editCodonTable'),
            cdsValidationSection: document.getElementById('cdsValidationSection'),
            validateCdsButton: document.getElementById('validateCdsButton'),
            validationResult: document.getElementById('validationResult'),
            exonList: document.getElementById('exonList'),
            addExonButton: document.getElementById('addExonButton'),
            loadingOverlay: document.getElementById('loadingOverlay')
        };

        // Application state
        const state = {
            currentData: {
                sequence_id: '',
                sequence_length: 0,
                features: [],
                session_id: ''
            },
            codonTables: []
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            fetchCodonTables();
        }

        // Set up event listeners
        function setupEventListeners() {
            dom.uploadForm.addEventListener('submit', handleUpload);
            dom.flipButton.addEventListener('click', handleFlip);
            dom.setOriginButton.addEventListener('click', handleSetOrigin);
            dom.featureOrigin.addEventListener('change', handleFeatureOriginSelect);
            dom.exportButton.addEventListener('click', handleExport);
            dom.addFeatureButton.addEventListener('click', () => openEditModal(-1));
            dom.editFeatureForm.addEventListener('submit', handleEditFeatureSubmit);
            dom.editType.addEventListener('change', updateEditForm);
            dom.validateCdsButton.addEventListener('click', validateCurrentCds);
            dom.addExonButton.addEventListener('click', addExonToEditForm);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && dom.editModal._isShown) {
                    dom.editModal.hide();
                }
            });
        }

        // Fetch codon tables
        async function fetchCodonTables() {
            try {
                const response = await fetch('/api/codon_tables');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                state.codonTables = data.map(table => ({
                    id: table.id,
                    name: table.name,
                    start_codons: table.start_codons,
                    stop_codons: table.stop_codons,
                    table: table.table
                }));
                
                populateCodonTableDropdown();
                
            } catch (error) {
                console.error('Error loading codon tables:', error);
                showAlert(`Failed to load codon tables: ${error.message}`, 'danger');
                
                state.codonTables = [{
                    id: "1",
                    name: "Standard",
                    start_codons: ["ATG", "TTG", "CTG"],
                    stop_codons: ["TAA", "TAG", "TGA"]
                }];
                populateCodonTableDropdown();
            }
        }

        // Populate the codon table dropdown
        function populateCodonTableDropdown() {
            dom.editCodonTable.innerHTML = '';
            state.codonTables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = table.name;
                dom.editCodonTable.appendChild(option);
            });
        }

        // Handle file upload
        async function handleUpload(e) {
            e.preventDefault();
            showLoading(true, 'Uploading files...');
            
            const formData = new FormData();
            if (dom.uploadForm.gff_file.files.length > 0) {
                formData.append('gff_file', dom.uploadForm.gff_file.files[0]);
            } else {
                showAlert('Please select a GFF3 file.', 'warning');
                showLoading(false);
                return;
            }
            if (dom.uploadForm.fasta_file.files.length > 0) {
                formData.append('fasta_file', dom.uploadForm.fasta_file.files[0]);
            } else {
                showAlert('Please select a FASTA file.', 'warning');
                showLoading(false);
                return;
            }

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                state.currentData = data;
                
                updateUI();
                
                showAlert('Files uploaded and parsed successfully!', 'success');

            } catch (error) {
                console.error('Upload error:', error);
                showAlert(`Error uploading files: ${error.message}`, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Update all UI elements
        function updateUI() {
            dom.sequenceId.textContent = state.currentData.sequence_id;
            dom.sequenceLength.textContent = state.currentData.sequence_length.toLocaleString();
            dom.mainContent.classList.remove('d-none');
            
            updateFeatureTable();
            updateFeatureOriginDropdown();
            
            if (state.currentData.session_id) {
                // IMPORTANT FIX: Ensure the 'config' parameter URL is absolute
                const absoluteConfigUrl = `/static/jbrowse2/data/${state.currentData.session_id}/config.json`;
                dom.jbrowseIframe.src = `/jbrowse/?session_id=${state.currentData.session_id}&config=${encodeURIComponent(absoluteConfigUrl)}`;
                console.log("Main page: JBrowse iframe src updated to:", dom.jbrowseIframe.src);
            } else {
                console.warn("Main page: No session_id available for JBrowse iframe update.");
            }
        }
        
        // Update the feature table
        function updateFeatureTable() {
            dom.featureTableBody.innerHTML = '';
            
            state.currentData.features.forEach((feature, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;
                
                const typeCell = document.createElement('td');
                typeCell.textContent = feature.type;
                typeCell.classList.add(`feature-${feature.type}`);
                row.appendChild(typeCell);
                
                const startCell = document.createElement('td');
                startCell.textContent = feature.start.toLocaleString();
                row.appendChild(startCell);
                
                const endCell = document.createElement('td');
                endCell.textContent = feature.end.toLocaleString();
                row.appendChild(endCell);
                
                const strandCell = document.createElement('td');
                strandCell.textContent = feature.strand === 1 ? '+' : '-';
                row.appendChild(strandCell);
                
                const geneCell = document.createElement('td');
                geneCell.textContent = feature.gene || '';
                row.appendChild(geneCell);
                
                const productCell = document.createElement('td');
                productCell.textContent = feature.product || '';
                row.appendChild(productCell);
                
                const noteCell = document.createElement('td');
                noteCell.textContent = feature.note || '';
                row.appendChild(noteCell);
                
                const codonStartCell = document.createElement('td');
                codonStartCell.textContent = feature.codon_start || '';
                row.appendChild(codonStartCell);
                
                const exonCell = document.createElement('td');
                exonCell.textContent = feature.exons ? feature.exons.length : 1;
                row.appendChild(exonCell);
                
                const actionsCell = document.createElement('td');
                actionsCell.className = 'text-nowrap';
                
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.className = 'btn btn-sm btn-primary me-2';
                editButton.addEventListener('click', () => openEditModal(index));
                actionsCell.appendChild(editButton);
                
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'btn btn-sm btn-danger';
                deleteButton.addEventListener('click', () => deleteFeature(index));
                actionsCell.appendChild(deleteButton);
                
                row.appendChild(actionsCell);
                
                dom.featureTableBody.appendChild(row);
            });
        }

        // Update the feature origin dropdown
        function updateFeatureOriginDropdown() {
            dom.featureOrigin.innerHTML = '<option value="">-- Select Feature --</option>';
            
            state.currentData.features.forEach((feature, index) => {
                if (feature.gene) {
                    const option = document.createElement('option');
                    option.value = feature.start;
                    option.textContent = `${feature.gene} (${feature.start.toLocaleString()}-${feature.end.toLocaleString()})`;
                    dom.featureOrigin.appendChild(option);
                }
            });
        }

        // Handle feature origin selection
        function handleFeatureOriginSelect() {
            if (dom.featureOrigin.value) {
                dom.originPosition.value = dom.featureOrigin.value;
            }
        }

        // Open the edit modal for a feature
        function openEditModal(index) {
            dom.editFeatureForm.reset();
            dom.validationResult.textContent = '';
            dom.validationResult.className = 'alert';
            dom.exonList.innerHTML = '';
            
            if (index === -1) {
                dom.editFeatureIndex.value = '-1';
                dom.editType.value = 'gene';
                dom.editStart.value = '1';
                dom.editEnd.value = '1';
                dom.editStrand.value = '1';
                dom.editCodonStart.value = '1';
                
                addExonToEditForm('1', state.currentData.sequence_length.toString(), '1');
            } else {
                const feature = state.currentData.features[index];
                dom.editFeatureIndex.value = index;
                dom.editType.value = feature.type;
                dom.editStart.value = feature.start;
                dom.editEnd.value = feature.end;
                dom.editStrand.value = feature.strand;
                dom.editGene.value = feature.gene || '';
                dom.editProduct.value = feature.product || '';
                dom.editNote.value = feature.note || '';
                dom.editCodonStart.value = feature.codon_start || '1';
                
                const exons = feature.exons && feature.exons.length ? feature.exons : [{
                    start: feature.start,
                    end: feature.end,
                    strand: feature.strand || 1
                }];
                
                exons.forEach(exon => {
                    addExonToEditForm(exon.start.toString(), exon.end.toString(), exon.strand.toString());
                });
            }
            
            updateEditForm();
            dom.editModal.show();
        }

        // Update edit form based on feature type
        function updateEditForm() {
            const isCds = dom.editType.value === 'CDS';
            dom.cdsValidationSection.classList.toggle('d-none', !isCds);
            
            const codonStartGroup = dom.editCodonStart.closest('.col-md-4');
            if (codonStartGroup) {
                codonStartGroup.classList.toggle('d-none', !isCds);
            }
        }

        // Add an exon to the edit form
        function addExonToEditForm(start = '', end = '', strand = '1') {
            const exonItem = document.createElement('li');
            exonItem.className = 'exon-item mb-2 p-2 bg-light rounded';
            
            const row = document.createElement('div');
            row.className = 'row g-2';
            
            const startCol = document.createElement('div');
            startCol.className = 'col-md-4';
            const startInput = document.createElement('input');
            startInput.type = 'number';
            startInput.min = '1';
            startInput.max = state.currentData.sequence_length;
            startInput.value = start || '';
            startInput.placeholder = 'Start';
            startInput.className = 'form-control form-control-sm';
            startInput.required = true;
            startCol.appendChild(startInput);
            row.appendChild(startCol);
            
            const endCol = document.createElement('div');
            endCol.className = 'col-md-4';
            const endInput = document.createElement('input');
            endInput.type = 'number';
            endInput.min = '1';
            endInput.max = state.currentData.sequence_length;
            endInput.value = end || '';
            endInput.placeholder = 'End';
            endInput.className = 'form-control form-control-sm';
            endInput.required = true;
            endCol.appendChild(endInput);
            row.appendChild(endCol);
            
            const strandCol = document.createElement('div');
            strandCol.className = 'col-md-3';
            const strandSelect = document.createElement('select');
            strandSelect.className = 'form-select form-select-sm';
            strandSelect.innerHTML = `
                <option value="1">+</option>
                <option value="-1">-</option>
            `;
            strandSelect.value = strand || '1';
            strandCol.appendChild(strandSelect);
            row.appendChild(strandCol);
            
            const deleteCol = document.createElement('div');
            deleteCol.className = 'col-md-1';
            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'btn btn-sm btn-outline-danger w-100';
            deleteButton.innerHTML = '&times;';
            deleteButton.addEventListener('click', () => {
                dom.exonList.removeChild(exonItem);
            });
            deleteCol.appendChild(deleteButton);
            row.appendChild(deleteCol);
            
            exonItem.appendChild(row);
            dom.exonList.appendChild(exonItem);
        }

        // Handle edit feature form submission
        async function handleEditFeatureSubmit(e) {
            e.preventDefault();
            showLoading(true);
            
            try {
                const index = parseInt(dom.editFeatureIndex.value);
                const exons = [];
                
                const exonItems = dom.exonList.querySelectorAll('.exon-item');
                exonItems.forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const select = item.querySelector('select');
                    
                    const start = parseInt(inputs[0].value);
                    const end = parseInt(inputs[1].value);
                    const strand = parseInt(select.value);

                    if (isNaN(start) || isNaN(end) || start < 1 || end < 1 || start > end || end > state.currentData.sequence_length) {
                        throw new Error('Invalid exon coordinates. Check start, end, and sequence length limits.');
                    }

                    exons.push({ start, end, strand });
                });

                if (exons.length === 0) {
                    throw new Error('At least one exon is required.');
                }

                const newFeature = {
                    type: dom.editType.value,
                    start: parseInt(dom.editStart.value),
                    end: parseInt(dom.editEnd.value),
                    strand: parseInt(dom.editStrand.value),
                    gene: dom.editGene.value,
                    product: dom.editProduct.value,
                    note: dom.editNote.value,
                    codon_start: dom.editCodonStart.value,
                    exons: exons
                };

                if (index === -1) {
                    state.currentData.features.push(newFeature);
                } else {
                    state.currentData.features[index] = newFeature;
                }

                updateUI();
                
                showAlert('Feature saved successfully!', 'success');
                dom.editModal.hide();

            } catch (error) {
                console.error('Error saving feature:', error);
                showAlert(`Error saving feature: ${error.message}`, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Delete a feature
        function deleteFeature(index) {
            if (confirm('Are you sure you want to delete this feature?')) {
                state.currentData.features.splice(index, 1);
                updateUI();
                showAlert('Feature deleted successfully!', 'info');
            }
        }

        // Validate current CDS feature
        async function validateCurrentCds() {
            const featureIndex = parseInt(dom.editFeatureIndex.value);
            if (featureIndex === -1) {
                showAlert('Please save the feature first before validating CDS.', 'warning');
                return;
            }

            const feature = state.currentData.features[featureIndex];
            const codonTableId = dom.editCodonTable.value;

            if (!feature || feature.type !== 'CDS' || !codonTableId) {
                showAlert('Please select a CDS feature and a codon table to validate.', 'warning');
                return;
            }

            showLoading(true, 'Validating CDS...');
            try {
                const response = await fetch('/validate_cds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        feature: feature,
                        codon_table: codonTableId,
                        sequence_length: state.currentData.sequence_length
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }

                const result = await response.json();
                
                dom.validationResult.textContent = result.message;
                dom.validationResult.className = `alert mt-2 ${result.valid ? 'alert-success validation-valid' : 'alert-danger validation-invalid'}`;

            } catch (error) {
                console.error('CDS validation error:', error);
                dom.validationResult.textContent = `Validation failed: ${error.message}`;
                dom.validationResult.className = 'alert mt-2 alert-danger validation-invalid';
            } finally {
                showLoading(false);
            }
        }

        // Handle flip sequence
        async function handleFlip() {
            if (!state.currentData.sequence_id) {
                showAlert('Please upload files first.', 'warning');
                return;
            }
            if (confirm('Are you sure you want to reverse complement the sequence and all features?')) {
                showLoading(true, 'Reversing Complement...');
                try {
                    const response = await fetch('/flip', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sequence_id: state.currentData.sequence_id,
                            sequence_length: state.currentData.sequence_length,
                            features: state.currentData.features
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    }

                    const data = await response.json();
                    state.currentData.sequence_length = data.sequence_length; 
                    state.currentData.features = data.features;
                    updateUI();
                    showAlert('Sequence and features reverse complemented!', 'success');

                } catch (error) {
                    console.error('Flip error:', error);
                    showAlert(`Error reversing complement: ${error.message}`, 'danger');
                } finally {
                    showLoading(false);
                }
            }
        }

        // Handle set origin
        async function handleSetOrigin() {
            if (!state.currentData.sequence_id) {
                showAlert('Please upload files first.', 'warning');
                return;
            }
            const newStart = parseInt(dom.originPosition.value);
            if (isNaN(newStart) || newStart < 1 || newStart > state.currentData.sequence_length) {
                showAlert(`Please enter a valid position between 1 and ${state.currentData.sequence_length}.`, 'warning');
                return;
            }

            if (confirm(`Are you sure you want to shift the origin to position ${newStart}?`)) {
                showLoading(true, 'Shifting origin...');
                try {
                    const response = await fetch('/shift_origin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sequence_id: state.currentData.sequence_id,
                            sequence_length: state.currentData.sequence_length,
                            features: state.currentData.features,
                            new_start: newStart
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    }

                    const data = await response.json();
                    state.currentData.features = data.features;
                    updateUI();
                    showAlert(`Origin shifted to ${newStart}!`, 'success');

                } catch (error) {
                    console.error('Shift origin error:', error);
                    showAlert(`Error shifting origin: ${error.message}`, 'danger');
                } finally {
                    showLoading(false);
                }
            }
        }

        // Handle export
        async function handleExport() {
            if (!state.currentData.sequence_id) {
                showAlert('Please upload files first.', 'warning');
                return;
            }
            showLoading(true, 'Exporting files...');
            try {
                const response = await fetch('/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sequence_id: state.currentData.sequence_id,
                        sequence_length: state.currentData.sequence_length,
                        features: state.currentData.features
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }

                const data = await response.json();

                downloadFile(data.gff, `${state.currentData.sequence_id}_annotated.gff3`, 'application/json');
                downloadFile(data.fasta, `${state.currentData.sequence_id}.fasta`, 'application/fasta');
                
                showAlert('Files exported successfully!', 'success');

            } catch (error) {
                console.error('Export error:', error);
                showAlert(`Error exporting files: ${error.message}`, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Helper to download files
        function downloadFile(content, filename, contentType) {
            const a = document.createElement('a');
            const file = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(file);
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 100);
        }

        // Show loading overlay
        function showLoading(show, message = 'Processing...') {
            if (show) {
                dom.loadingOverlay.classList.remove('d-none');
                dom.loadingOverlay.querySelector('p').textContent = message;
            } else {
                dom.loadingOverlay.classList.add('d-none');
            }
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }, 5000);
        }

        // Initialize the application
        init();
    });
    </script>
</body>
</html>
